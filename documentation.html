
<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>Weight Track</title>
	<style>
	@import "https://fonts.googleapis.com/css?family=Alef:400,700&subset=hebrew";

body {
    direction: rtl;
    font-family: Alef, sans-serif;
    background-color: #cc99ff;
    font-size: 24px;
    color: #173e43;
    margin: 0;
    padding-top: 80px; 
}

header {
	position: fixed;
	background: white;
	height: 80px;
	padding: 0 15px;
	width: 100%;
	top: 0;
}
header a{
	display: inline-block;
	vertical-align: bottom;
	box-sizing: border-box;
	color: black;
	text-decoration: none;
	margin-left: 20px;
	padding-bottom: -20px;
}


header a:hover{
	text-decoration: underline;
}


#logoContainer{
	height: 65px;
}

h1 {
    font-size: 2.25em;
    text-align: center;
}


img.resize {
  max-height:270px;
  display: block;
    margin: auto;
	margin-bottom: 25px;
	margin-top: 25px;
}

img.tarshim {

  display: block;
    margin: auto;
	margin-bottom: 25px;
	margin-top: 25px;
}

h2 {
    font-size: 2em;
    margin-bottom: 25px;
	padding-top: 80px;
    margin-top: -80px;
}

main {
    max-width: 1024px;
    margin: auto;
    background-color: rgba(255, 255, 255, 0.7);
    padding: 20px 110px 20px 60px;
    box-sizing: border-box;
}

p {
    text-align: justify;
}



span.highlight {
    font-weight: bold;
}

section {
    border-right: 5px solid #a5cae9;
    padding-right: 30px;
    margin-bottom: 60px;
}

code {
	font-family: monospace;
	font-size: 20px;
}


	</style>
</head>
<body>
<header >
    
    <a href="#L1">
        המוצר ושימושיו
    </a>
    <a href="#L2">
        חומרה
    </a>
    <a href="#L3">
        Raspberry Pie
    </a>
	<a href="#L4">
		האפליקציה
	</a>
	<a href="#L5">
		אתגרים ודרכי פתרון
	</a>
</header>
<main >

    <article>
        <section>
            <h2 id="L1">
                המוצר ושימושיו
            </h2>
            <figure>
              
            </figure>
            <p>

				Weight Track הוא משקל דיגיטלי חכם ושם האפליקציה הסלולרית הנלווית אליו. בכל פעם שהמשתמש עולה להשקל, נתוני השקילה נשמרים בבסיס נתונים בענן.  האפליקציה מספקת ממשק נוח ואינטראקטיבי המאפשר למשתמש לקבל לא רק את תוצאת השקילה אלא גם סטטיסטיקות נוספות הקשורות בשקילות קודמות ותצוגות מתקדמות באמצעות גרפים. המכשיר מיועד בעיקר לשימוש ביתי. הוא מועיל במיוחד לספורטאים, שומרי משקל, מטופלים תחת מעקב רפואי או  לכל החפץ לנהל מעקב מדוייק אחר השינויים במשקלו. בנוסף מתאים המכשיר גם לשימושים עסקיים כמו חדרי כושר, קופות חולים, קניונים, מסלולי הליכה עירוניים וכו'.
            </p>
            <p>
                Weight Track מצוייד במכשיר Raspberry Pie (להלן RPI). בשימוש הראשון יש להתקין את ה-RPI. לאחר מכן ניתן להתחיל להשקל. לפני כל שקילה יש לסרוק באמצעות האפליקציה את קוד ה-QR המצורף למכשיר ה-Weight Track ולאחר מכן לעלות על המשקל ולהשקל כרגיל. 
            </p>
        </section>
        <section>
            <h2 id="L2">
                חומרה
                
            </h2>
			
			<ul>
				<li>
					<h4>Raspberry Pie 2</h4>
					<img class="resize" src="https://www.raspberrypi.org/app/uploads/2017/05/Raspberry-Pi-Model-B-462x322.jpg">
				</li>
				<li>
					<a href="https://www.sparkfun.com/products/13879">SparkFun Load Cell Amplifier - HX711</a>
					<img class="resize" src="https://cdn.sparkfun.com//assets/parts/1/1/5/1/0/13879-01.jpg">
				</li>
				<li>
					<a href="https://www.sparkfun.com/products/13878">SparkFun Load Sensor Combinator</a>
					<img class="resize" src="https://cdn.sparkfun.com//assets/parts/1/1/5/0/9/13878-01.jpg">
				</li>
				<li>
					<h4>משקל דיגיטלי ביתי</h4>
				</li>

			</ul>
			
			<h3>הרכבת החומרה</h3>
			<p>לקחנו משקל דיגיטלי ביתי ונתקנו ממנו את המעגל החשמלי שלו. במשקל ישנם ארבעה חיישני משקל מסוג Load Cell, ולכל אחד מהם שלושה חוטים (אדום, שחור, לבן) המחוברים למעגל החשמלי. להלן תרשים של החיישן:</p>
				<img class="resize" src="https://cdn.sparkfun.com/assets/learn_tutorials/3/8/3/20100816-3wirestraingauge.png">
			<p>
				מכיוון שאין סטנדרטיזציה לצבע החוטים, השתמשנו במולטימטר על מנת למדוד את ההתנגדות בין כל זוג חוטים. היה עלינו למצוא את הזוג בעל ההתנגדות הגבוהה ביותר. במשקל שלנו ההתנגדות הגבוהה ביותר נמצאה בין החוט הלבן לשחור. נעזרנו במנחה הסדנה על מנת להלחים את החוטים אל ה-Combinator באופן הבא: החוטים השחורים למינוס (-), הלבנים לפלוס (+) והאדומים למרכז (C):
			</p>
			<img class="resize" src="https://cdn.sparkfun.com//assets/parts/1/1/5/0/9/13878-04.jpg">
			<p>
				אחת הדרכים לקחת שינויי התנגדות קטנים ולהופכם למשהו מדיד היא שימוש ב-
				<a href="https://en.wikipedia.org/wiki/Wheatstone_bridge">Wheatstone bridge</a>
				. זוהי תצורה של ארבעה נגדים ומתח קבוע מראש, כמתואר בתרשים:
			</p>
			<img class="resize" src="https://cdn.sparkfun.com/assets/learn_tutorials/3/8/2/wheatstone_bridge.gif">
			<p>
				ה-Combinator מחבר יחדיו את ארבעת החיישנים באופן כזה ששני נגדים בתצורת ה-wheatstone bridge הינם קבועים, והשניים האחרים משתנים.
			</p>
			<p>
				לאחר הלחמת תריסר החוטים אל ה-Combinator חברנו אותו אל הלוח של מגבר ה-HX711 דרך ארבעת החוטים הסטנדרטיים של Load Cell.
			</p>
			<p>
				לבסוף חיברנו את ה-Raspberry Pie למגבר דרך יציאות GPIO.
			</p>
			           
        </section>
        <section>
            <h2 id="L3">
                Raspberry Pie
            </h2>
			<img class="tarshim" src="https://lh3.googleusercontent.com/FVMWGFT4AinfjkklwWMvmdIN21oP1O2e9aSVF3zvOM_fbVDhHDmJEIx8CtU4IeOON4pMZ6jbQStoEj1qPNH78GWpVzTOFdoNl0eEdKVC6wiNha-8u_iQJcU1WYTIbn5C8syu3BZhp_ff7KwY2mtsDnA4upg7IpnoLLSz-ZrE8taf_S5dMaYvo_Ydeendu23VHVAGyGUBvJIinxDec3eUCWCY7yW4GvbMcc4Ff1icVi2wB6debDjHid_uu5psEXLGdMcslSIdMjqK6Bjq72CMwG63fA0BnVxyqI7grKu2i4cVY-pTtHyoIAhN9HP96sT-8t9Vuvtxs-9e3qxBRMqbYR-7cl9XYknlq-7aa45Nblio-ohkTka-rdH7AyuHZIwnyIx-jZmXrVjRJItkerTRrqhby_bLVHs9wPBanBxfKgL7JVr_N7SfBajhdXrvYLXWEj3dcr4rv0qz_OWV6sDYkAFTRJBdceeuy4Kg2ZPTjxcjAXtmUqVa0C6GgRag0qoaLQtXuEC2uqUrEINSyyJeuNslcP9iMuSkbo18an65wrAGyIFZNVjbAn-gWoRP-Pm8G5mMmXEsoKvZCh3YQ6gtgOwDgz-gXmyFBp3Hz0mtYw=w574-h529-no">
			<h3>
				התוכנית אשר רצה על ה-Raspberry Pie
			</h3>
				<p>
					התוכנית אשר רצה על מכשיר ה Raspberry Pi בנויה בטכנולוגית Windows Universal Platform ונבנתה באמצעות Visual Studio 2017.
				</p>
				<p>
					התוכנית בנויה במבנה הדומה במידה רבה לשרת אינטרנט, כלומר התוכנית מאזינה באופן קבוע לבקשות התחברות מצד הלקוחות. כאשר מתקבלת בקשה, התוכנית מספקת את שירותה, שולחת חיווי ללקוח ואז סוגרת את החיבור.
				</p>
				<p>
					התוכנית ממשת ארבע פונקציות עיקריות כמפורט להלן:
				</p>
			<h3>
				התממשקות לחומרה
			</h3>
				<p>
					ההתממשקות לחומרה נעשת על ידי מנשק בשם UserHardwareLinker (או בקיצור uhl), זהו למעשה הרחבה של הממשק הבסיסי אשר מתממשק לרכיב hx711. בנוסף לפעולות הבסיסיות של קבלת נתוני השקילה, ה-uhl עוקב אחר המשתמשים ויודע בכל עת האם המשקל נמצא בשימוש, ולהחזיר את פרטי המשתמשים אשר משתמשים במשקל.
				</p>
				<p>
					הממשק המקשר בין החומרה לתוכנה הינו מחלקה ב-C# אשר מהווה חלק מהתוכנית הראשית שרצה על גבי ה Raspberry Pi. שמו של המנשק הינו LinearHX. זהו למעשה תרגום שביצענו עבור מחלקה שנכתבה עבור אנדרואיד בשפת C++: <a href="https://github.com/bogde/HX711">לעיון בקוד לחץ כאן.</a>
				</p>
				<p>
					מעבר לתרגום הקוד הנ"ל כך שיתאים לרספברי פיי, הוספנו בו מספר פונקציות אשר מממשות את תהליך הכיול של המשקל בצורה קלה ונוחה יותר לשימוש עבור הצרכים שלנו.
				</p>
				<p>
					משך השקילה עורך כ-5 שניות. במהלכה הסנסור מבצע את השקילה מספר רב של פעמים (כאלף פעמים) ומחזיר את ממוצע השקילות שבוצעו. באופן זה אנו ממזערים את אי-דיוקים של הסנסור.
				</p>
				
			<h3>
				התחברות לענן Microsoft Azure – 
			</h3>
				<p>
					ההתחברות לענן נעשית בעזרת IoT Hub. רכיב זה נמצא בענן ומאזין להודעות אשר אשר נשלחות מהתוכנית אל הענן.
				</p>
				<p>
					התוכנית שולחת הודעה לענן  בשתי סיטואציות:
				</p>
				<ul>
					<li>רישום המכשיר לענן, או עדכות כתובתו </li>
					<li>שליחת הנתונים שהתקבלו ממד-המשקל יחד עם של המשתמש אשר ביצע את השקילה ותאריך השקילה</li>
				</ul>
			<h3>
				האזנה לבקשות התחברות 
			</h3>
				<p>
					כאשר משתמש רוצה לבצע שקילה עליו להודיע לתוכנית כי ברצונו להישקל. כאשר התוכנית מקבלת את ההודעה, היא יכולה לפנות לממשק ה-uhl לשם קבלת הנתונים מהסנסור.
				</p>
				<p>
					שליחת ההודעות נעשית באמצעות פרוטוקול אשר פותח על ידנו בשם Data Request Protocol (או בראשי-תיבות DRP). DRP הינו פרוטוקול תקשורת אשר יושב מעל פרוטוקול TCP הסטנדרטי. יצירת החיבור בין האפליקציה אצל הלקוח ומכשיר הרספברי פיי ממושת באמצעות Socket. התוכנית מקימה שרת בסיסי אשר מאזין להודעות DRP ומשרת אותן. <a href="#DRP">לחץ כאן להסבר מפורט על הפרוטוקול.</a>
				</p>
				
			<h3>
				תחזוקת הגדרות בסיסיות, ואספקת ממשק נוח המאפשר גישה להגדרות אלו
			</h3>
				<p>
					על הלקוח לספק למכשיר מספר הגדרות ראשונית בסיסיות, כלומר הגדרות שיש להגדירן באופן חד פעמי לפני השימוש במכשיר פעם הראשונה. אי-לכך יצרנו ממשק נוח המפאשר למשתמש גישה להגדרות המכשיר ולשינויים. ההגדרות נשמרות על כרטיס ה-SSD של ה-Raspberry Pi, ולכן אינן משתנות גם לאחר כיבוי והפעלה מחדש של המכשיר.
				</p>
				<p>
					הנתונים שנשמרים הינם:
				</p>
				<ul>
					<li>שם מד-המשקל (ניתנת למשתמש האפשרות לתת למכשיר שברשותו שם אשר יוצג למשתמשים הנשקלים. זה יכול להיות נוח עבור משתמשים עסקיים(</li>
					<li>המספר הסידורי של המשקל</li>
					<li>כתובת ה-IP של המשקל כפי שנצפתה לאחרונה</li>
					<li>נתוני הכיול של המשקל</li>
				</ul>
				<p>
					הגישה לנתונים אלו נעשית באמצעות ממשק WEB ולכן יכולה להתבצע מכל דפדפן סטנדרטי. המכשיר מתחזק שרת HTTP פשוט אשר מאזין לפורט 9000, ושולח את דף ההגדרות לכל לקוח אשר מנסה לגשת להגדרות המכשיר. הגישה להגדרות מתבצעת ע"י הזנת כתובת ה IP של המכשיר והפורט בשורת הכתובת של הדפדפן. למשל :   http://10.0.0.2:9000
				</p>
				
				
			
        </section>
        <section>
            <h2 id="L4">
                האפליקציה
            </h2>
            <p>
                בפרוייקט זה הפכנו משקל-אמבטיה רגיל למשקל המחובר לאינטרנט. שקילות המשתמש מאוחסנות בענן של Azure בתוך מסד נתונים SQL. זה מאפשר למשתמש לעקוב אחר הסטוריית השקילות שלו מכל מכשיר Weight Track.

            </p>
			<p>
				המשתמש יכול לקנות מכשיר Weight Track לשימוש בבית. אך אין זה תנאי הכרחי. כל שעליו לעשות הוא להוריד את אפליקציית Weight Track לאנדרואיד, מה שיאפשר לו להשתמש בכל מכשיר Weight Track בעולם. 
			</p>
			<h3>מעבר הנתונים:</h3>
				<img class="tarshim" src="https://lh3.googleusercontent.com/fbxhjLkuTi57S0lvfbFOS3hsk_EXxn3QIw7ICPsBO4ve4ct6HvtquQRrL8qvhD3GsgeebbVzK8zHfzd8C-U0glJbWSYcUrYLt-vBbqDoo4k7Q3K-5XCzekCNqihzYRbxGH84DxVlbtHj2MpcpW-3qsC7lZl6hT0jpkXV85fngrAg4LPM6KHYtYYWXj7VQXVeez2wXghHhNZ-1GxtrSPz4i6hhLOwmJ6fHF9dIiZd__YatdwvP9Up4iwxFvBJhO74oMTBBpb0i79qEa1pOvbmzA0dCXV_37yJzu0uncs6R2wEhn4CKm3FwmMFMCd1ykAK7sXwaIpDP5GDBWEP4laLxOBkA2IMUcQJehXezDPP9xihvycXnGecTWdXicpOqdfz3RAxK-af3qC7ZwmaX62j3uXjufJAafSUDqGV5Yqy1VjEOp5C_Zxc5wOxFouH29nadd-7GPqrf3WLMVzepPAXaChCBA418_zKTcfS9kcL0ai6CWlQM0Br0DS8QBvsNLA94kjK6gR4JRE4A_NrAY2uHs5YRr_MYQPksMnR1zqyHosG6VyMBn96y0N1oHzau7yp5mqSgxhJulYOV2b6rdYQWXdfa8z0BsGgO6a5Cd-nLw=w760-h372-no">
			<h3>האפליקציה לאנדרואיד</h3>
				<p>
					האפליקציה הינה אפליקציית Xamarin.Android אשר משתמשת בשירותי Azure כגון מסד נתונים SQL, IoTHub, StreamAnalytics ואימות באמצעות הפייסבוק. צד השרת הוא קוד javascript ומנוהל על ידי Azure. כתובת ה-URL של צד השרת:
				</p>
				<a href="http://iotweight.azurewebsites.net">http://iotweight.azurewebsites.net</a>
				<p>
					צד הלקוח הוא תוכנית Xamarin.Android  (C#)
				</p>
			<h3>פרופיל משתמש</h3>
				<p>
					התחברות המשתמש לאפליקציה נעשית דרך הפייסבוק. בפעם הראשונה בה המשתמש מתחבר לאפליקציה, מוצג לפניו מסך התחברות דרך הפייסבוק, ועליו להזין את כתובת הדואר האלקטרוני והסיסמה איתם הוא רשום לפייסבוק. אז נוצר לו מספר זהות ייחודי ע"י ה-Azure המבוסס על כתובת המייל שהזין. מספר הזהות הזה מתאחסן במסד מידע SQL שבענן, ומשמש לזיהוי ייחודי של המשתמש. על ידי ביצוע תהליך האימות דרך פייסבוק אנו נמנעים מלאחסן כתובות דואר אלקטרוני וסיסמאות במסד המידע שלנו. לכן המימוש הזה בטוח יותר מזה האלטרנטיבי (כפי שמוסבר בספר המקוון
					<a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter2/custom/">הזה</a>
					שנכתב בידי מפתח מייקרוסופט.)
				</p>
				<p>
					המשתמש יכול להוסיף להוסיף לפרופיל שלו גם נתון גובה, ואז יוכל להשתמש במחשבון ה-BMI שבאפליקציה (הסבר מפורט בהמשך).
				</p>
				<p>הפרופילים של המשתמשים מאוחסנים בטבלת SQL הנקראת <code>UsersTable</code>, המכילה את השדות הבאים:</p>
				<ul>
					<li><code>string UniqueUsername</code> - זהו מספר הזהות הייחודי</li>
					<li><code>float height</code> - אופציונאלי</li>
				</ul>
			<h3>


        </section>
    </article>
</main>
</body>
</html>
